#!/usr/bin/env bash
# Setup script for Profile Generator

set -e

echo "üöÄ Setting up Profile Generator..."
echo ""

# Check Ruby version
echo "Checking Ruby version..."
if ! command -v ruby &> /dev/null; then
    echo "‚ùå Ruby is not installed. Please install Ruby 3.4 or higher."
    exit 1
fi

ruby_version=$(ruby -v | grep -oE '[0-9]+\.[0-9]+' | head -1)
echo "‚úì Ruby $ruby_version found"

# Check Bundler
echo ""
echo "Checking Bundler..."
if ! command -v bundle &> /dev/null; then
    echo "Installing Bundler..."
    gem install bundler
fi
echo "‚úì Bundler found"

# Install dependencies
echo ""
echo "Cleaning up problematic gem versions..."
sudo rm -f /usr/local/bundle/specifications/{stringio-3.1.7,stringio-3.1.8,racc-1.8.1,prism-1.5.1,prism-1.5.2,prism-1.6.0,nio4r-2.7.4,json-2.15.0,json-2.16.0,io-console-0.8.1,date-3.4.1,date-3.5.0,cgi-0.5.0,bigdecimal-3.2.3}.gemspec 2>/dev/null || true

echo "Installing dependencies..."
bundle install
echo "‚úì Dependencies installed"

# Install Node dependencies and Playwright
echo ""
echo "Checking for Node.js..."
if command -v npm &> /dev/null; then
    echo "Installing Node dependencies..."
    npm install
    echo "Installing Playwright browsers..."
    npx playwright install --with-deps
    echo "‚úì Node dependencies and Playwright installed"
else
    echo "‚ö†Ô∏è  Node.js/npm not found. Skipping Playwright installation."
fi

# Set up .env file
echo ""
if [ ! -f .env ]; then
    echo "Creating .env file..."
    cp .env.example .env
    echo "‚úì .env file created"
    echo ""
    echo "‚ö†Ô∏è  IMPORTANT: Edit .env file and add your ANTHROPIC_API_KEY"
    echo "   Get your API key from: https://console.anthropic.com/"
else
    echo "‚úì .env file already exists"
fi

# Check if API key is set
echo ""
if grep -q "your_api_key_here" .env 2>/dev/null; then
    echo "‚ö†Ô∏è  WARNING: ANTHROPIC_API_KEY is not set in .env file"
    echo "   Please edit .env and add your API key before running the app"
else
    echo "‚úì ANTHROPIC_API_KEY appears to be configured"
fi

# Success message
echo ""
echo "‚úÖ Setup complete!"
echo ""
echo "To start the application:"
echo "  Development mode:  bundle exec rake dev"
echo "  Production mode:   bundle exec rake server"
echo ""
echo "The app will be available at: http://localhost:4567"
echo ""
echo "For more information, see README.md"
